---
layout: post
---
a page about nginx
本文主要分3个部分介绍nginx，适合nginx基础入门

## location

```
location [ = | ~ | ~* | ^~ ] uri { ... }
location @name { ... }
```
>更多内容请参考官方文档: [location][location]

`@name`主要用于服务器内部转发，不作主要讲解。
按照匹配方式，分为两类匹配：
字符串匹配和正则匹配。

多条location如何匹配？

按照官网的描述，
location匹配请求，nginx首先检查前缀字符串的location。
匹配到的最长的location被选中和记住。
然后检查正则，正则搜索在第一次匹配时停止，并使用相应位置。如果找不到匹配项，则使用前面记住的前缀匹配。
如果最长匹配location有^~，则不检查正则
=找到完全匹配，终止搜索。

```conf
location = / {
  # 精确匹配 /，匹配到就停止
  [ configuration A ]
}

location  / {
  # 普通字符串匹配
  # 因为所有的地址都以 / 开头，所以这条规则将匹配到所有请求
  # 但是不一定应用此匹配
  [ configuration B ] 
}

location  /documents {
  # 普通字符串匹配
  # 匹配以/documents开头的地址
  # 但是不一定应用此匹配
  [ configuration C ] 
}

location  /documents/ {
  # 普通字符串匹配
  # 匹配以/documents/开头的地址
  # 但是不一定应用此匹配
  [ configuration C ] 
}

location /documents/abc {
  # 比上面的字符串更长
  [ configuration D ]
}

location ^~ /documents/ {
  # 如果此location是最长匹配前缀location, 则不检查正则location.
  [ configuration E ]
}

location ~ /documents/ {
  # 分大小写的正则匹配
  # 执行到正则location, 如果命中，则停止匹配，应用此条配置
  [ configuration F ]
}

location ~* \.(gif|jpg|jpeg|png)$ {
  # 不区分大小写的正则匹配
  # 匹配以gif jpg jpeg png结尾的地址
  [ configuration G ]
}


```

按照上面的匹配规则，有以下示例
`/` -> A <br/>
`/documents/efg` -> E <br/>
`/documents/abc/` -> D <br/>
`/images/logo.png` -> G <br/>

### 关于斜杠

有这样两个location`/documents`和 `/documents/`
访问`/documents`会产生一个301重定向到`/documents/`。


> 官网location一章中，对前缀匹配和斜杠有这样的描述：
> If a location is defined by a prefix string that ends with the slash character, and requests are processed by one of proxy_pass, fastcgi_pass, uwsgi_pass, scgi_pass, memcached_pass, or grpc_pass, then the special processing is performed. In response to a request with URI equal to this string, but without the trailing slash, a permanent redirect with the code 301 will be returned to the requested URI with the slash appended. If this is not desired, an exact match of the URI and location could be defined...
> 笔者在nginx/1.17.8版本中并没有观察到此现象。在更高的版本是否可以有此现象？


什么会导致301重定向
什么会导致10次循环，不然会报503错误

## proxy_pass

这里主要介绍斜线对`proxy_pass`的影响。

```conf
# 访问127.0.0.1/api/test

location /api {
  proxy_pass http://127.0.0.1:8888;
  # 实际访问地址：127.0.0.1:8888/api/test
}

location /api/ {
  proxy_pass http://127.0.0.1:8888;
  # 实际访问地址：127.0.0.1:8888/api/test
}

location /api {
  proxy_pass http://127.0.0.1:8888/;
  # 实际访问地址：127.0.0.1:8888//test
}

location /api/ {
  proxy_pass http://127.0.0.1:8888/;
  # 实际访问地址：127.0.0.1:8888/test
}

location /api {
  proxy_pass http://127.0.0.1:8888/api;
  # 实际访问地址：127.0.0.1:8888/api/test
}

location /api/ {
  proxy_pass http://127.0.0.1:8888/api;
  # 实际访问地址：127.0.0.1:8888/apitest
}

location /api {
  proxy_pass http://127.0.0.1:8888/api/;
  # 实际访问地址：127.0.0.1:8888/api//test
}

location /api/ {
  proxy_pass http://127.0.0.1:8888/api/;
  # 实际访问地址：127.0.0.1:8888/api/test
}
```
可见，proxy_pass后面加了斜杠，location前缀都不会加到实际路径中，包括`http://127.0.0.1:888/api\/?`这种形式


## 应用

笔者在某些前端项目的接口调试，如接口需要https协议项目、前后端不分离项目，就需要nginx辅助调试。

下面举个简单的例子来看看nginx在前端项目调试中的应用。



## rewrite

test for conf

{% highlight conf %}

location = / {

# 精确匹配 /，匹配到就停止

  [ configuration A ]
}
{% endhighlight %}

{% highlight ruby %}
def print_hi(name)
  puts "Hi, #{name}"
end
print_hi('Tom')
# => prints 'Hi, Tom' to STDOUT.
Syntax:
{% endhighlight %}

[location]: http://nginx.org/en/docs/http/ngx_http_core_module.html#location

可能遇到的问题文件夹无权限
